# 政府会議ページサマリー作成 - 共通ワークフロー

このドキュメントは、政府会議ページのサマリー作成スキルで使用される共通の処理フローを定義しています。
各府省庁スキル（pagereport-cas, pagereport-cao, pagereport-meti）はこのワークフローを参照します。

---

# 引数

- URL（HTMLページまたはPDFファイル）
  - 会議名はHTMLから自動的に抽出されます

# 出力仕様

1つのファイルを生成:
- `output/{会議名}_{回数}_{日付}_report.md` - サマリーと詳細を統合したレポート

**report.md の構成:**
- 基本情報（会議名、日時、場所）
- **アブストラクト（1,000字以内）**: 論文のabstract形式で構造化された要約（コードフェンスで囲む）
- 配布資料一覧
- 詳細な会議情報（議事次第、会議概要、議事録）
- 各資料の要約と主要ポイント
- 全体のまとめ
- 参考リンク

# 処理フロー

## 概要（11ステップ）

1. **コンテンツ取得**: HTMLページまたはPDFの取得とクリーニング
2. **メタデータ抽出**: 会議名、日付、回数、場所を自動抽出
3. **会議概要作成**: HTMLまたは議事次第PDFから概要を抽出
4. **議事録参照**: 実際の発言内容を確認
5. **資料の選択とダウンロード**: 優先度スコアリングで重要資料を選択してダウンロード
6. **文書タイプ判定**: PDFダウンロード後、最初の5ページで判定（Word/PowerPoint/その他）← **重要ステップ**
7. **PDF→Markdown変換**: 判定結果に基づきdocling/pdftotextで変換← **重要ステップ**
8. **資料の読み取りと分析**: 変換後のMarkdownを文書タイプ別に効率的に読み取り
9. **要約生成**: アブストラクト（1,000字）+ 詳細レポート作成
10. **ファイル出力**: report.mdファイルを出力ディレクトリに生成
11. **Bluesky投稿**: アブストラクトをBlueskyに投稿

---

## ステップ1: コンテンツ取得とクリーニング

### HTMLページの場合
1. WebFetchでページを取得
2. **不要要素を削除**:
   - ヘッダー（ページ上部のナビゲーション、ロゴ、検索ボックス）
   - フッター、サイドバー、パンくずリスト
   - 広告、補助的なコンテンツ
3. **保持する要素**:
   - 会議録、報告書、議事次第、重要な決定事項
   - 本質的なコンテンツ（見出し、リスト、表、リンク）

### PDFの場合（ローカルファイル）
1. Readツールで直接読み取り

### PDFの場合（リモートURL）
1. 後述のステップ6-4でダウンロードしてから読み取り

## ステップ2: メタデータ自動抽出

HTMLまたはPDFから以下を抽出:
- **会議名**: ページタイトル、h1要素、またはPDFタイトルから正式名称を抽出
  - 例: 「日本成長戦略会議」「成長戦略会議」など
  - HTMLの場合: `<title>` タグ、`<h1>` タグ、パンくずリストから抽出
  - PDFの場合: メタデータまたは1ページ目のタイトルから抽出
- **開催日時**: 「令和X年Y月Z日」→ YYYYMMDD形式に変換
- **回数**: 「第X回」を抽出
- **開催場所**
- **議事内容**（概要）

会議名、日付、回数が取得できない場合は、ユーザーに確認する。

## ステップ2.5: ページタイプ判定（サブエージェント呼び出し）

**重要**: このステップで`page-type-detector`サブエージェントをTaskツールで呼び出し、ページタイプを判定します。

Taskツールで自動実行（ユーザー確認なし）:
- subagent_type: "page-type-detector"
- prompt: HTMLコンテンツ、ページタイトル、PDF数を含む詳細なプロンプト
- 結果: JSON形式で判定結果（MEETING/REPORT）が返される

**【重要】サブエージェント完了後の自動継続:**

サブエージェントがJSON形式で判定結果を出力したら、それはサブエージェント処理の**完了を意味します**。

**即座に実行すべきこと:**
1. ✓ 判定結果（MEETING/REPORT）を受け取る
2. ✓ **ユーザーの入力や確認を一切待たず、直ちにステップ3（会議概要の作成）に進む**

**禁止事項:**
- ✗ 判定結果だけ表示して停止しない
- ✗ ユーザーの応答を待たない

---

## ステップ3: 会議概要の作成

### パターンA: HTMLに概要が記載されている場合
- HTML本文から抽出

### パターンB: 「議事次第」PDFがある場合
- 議事次第PDFから以下を抽出:
  - 会議名、日付、場所
  - 主要議題項目

## ステップ4: 議事録の参照

### 3つのパターン
1. **HTML本文に議事録あり**: HTML本文から抽出
2. **議事録PDFあり**: 議事録PDFから実際の発言内容を抽出
3. **いずれも存在しない**: スキップ

**検証**: 実際の参加者の発言が含まれているか確認（「○○大臣」「○○委員」など）

## ステップ5: 資料の選択とダウンロード

### 5-1. PDFリンクの検出と絶対URL化
HTMLから全PDFリンクを抽出し、相対パスを絶対URLに変換。

### 5-2. 資料の優先度判定（1-5点スコアリング）

各資料を以下の基準で評価:
- 要約への関連性
- 内容の重要性
- 文書タイプ
- 時系列的位置

**重要な調整ルール**:
1. ✓ 実質的な資料がある場合、議事次第に最高スコア(5)を与えない
2. ✓ 参考資料と通常資料が両方ある場合、参考資料は最大4点まで
3. ✓ 概要と全文が両方ある場合 → 概要優先、全文スコアを1段階下げる
4. ✓ **除外対象**: 委員名簿、座席表、公開方法
5. ✓ **個人名・団体名の資料**（取組資料）の扱い:
   - 「○○委員」「○○教授」など個人名が含まれる資料
   - 企業名、社団法人名、財団法人名などが含まれる資料
   - これらは各委員・団体が提出した取組資料と推測される
   - **原則**: 事務局資料（Executive Summary、とりまとめ、概要、戦略等）がある場合、
     個人名・団体名の資料は読む対象にしない（スコア1-2程度の低優先度）
   - **例外**: 事務局資料がなく、議事次第・委員名簿以外に個人名・団体名の資料しかない場合、
     これらを読んで簡潔にまとめる

**ファイル名パターン認識**:
- **高優先度**: `shiryou1.pdf`, `shiryou2.pdf`（番号が若い）、`honpen.pdf`、`gaiyou.pdf`
- **低優先度**: `sankou*.pdf`（参考）、`betshi*.pdf`（別紙）、`meibo.pdf`（名簿）

**議事録での言及度分析**:
- 具体的言及（「資料X」「XX大臣説明資料」） → 重要度+2
- 間接的言及（「詳細は資料参照」） → 重要度+1
- 言及なし → 重要度-1

### 5-3. 上位資料のみ選択
スコア上位の資料のみを選択（目安: 上位3-5個、または スコア4以上）

### 5-4. PDFのダウンロード（重要）

**リモートPDFの取得方法:**

選択した高優先度PDFをスクリプトでダウンロード:

```bash
# 通常のダウンロード（CAS, CAOなど）
bash .claude/skills/common/scripts/download_pdf.sh "https://example.com/shidai.pdf" "/tmp/shidai.pdf"
bash .claude/skills/common/scripts/download_pdf.sh "https://example.com/shiryou1-1.pdf" "/tmp/shiryou1-1.pdf"

# User-Agent必須のサイト（METI, Chusho, MHLW, FSAなど）
bash .claude/skills/common/scripts/download_pdf_with_useragent.sh "https://www.meti.go.jp/doc.pdf" "/tmp/doc.pdf"
```

**ポイント:**
- `/tmp/` ディレクトリに保存（一時ファイル）
- ファイル名は元のファイル名を維持
- ダウンロード失敗時はエラーをログして次へ進む
- 並列ダウンロードは避ける（順次実行）
- METI/Chusho等のサイトは必ず `download_pdf_with_useragent.sh` を使用

## ステップ6: 文書タイプ判定

**目的**: ダウンロードした各PDFの文書タイプを判定し、ステップ7で適切な変換方法（docling/pdftotext）を選択する。

### 前提条件チェック: サブエージェント利用可能性

**重要**: このステップを開始する前に、`document-type-classifier`サブエージェントが利用可能かを確認する必要があります。

**利用可能性の判定基準:**
- Skillツールの利用可能なスキルリストに`document-type-classifier`が含まれている
- サブエージェントのSKILL.mdに適切なYAMLフロントマターが設定されている

**サブエージェントが利用できない場合の処理:**
1. **エラーメッセージを表示**:
   ```
   【エラー】document-type-classifierサブエージェントが利用できません。

   原因:
   - サブエージェントのSKILL.mdにYAMLフロントマターがない
   - allowed-toolsの設定が不足している
   - Claude Codeの設定に問題がある

   対処方法:
   1. .claude/skills/document-type-classifier/SKILL.mdを確認
   2. YAMLフロントマター（name, description, allowed-tools）が正しく設定されているか確認
   3. Claude Codeセッションを再起動

   サブエージェントが利用できない状態では、並列処理の利点が失われ、
   処理時間が大幅に増加するため、処理を中断します。
   ```

2. **処理を終了**: レポート生成を中断し、ユーザーに修正を促す

**注意**: 代替処理（PDFを直接読んで判定）は実装しません。サブエージェントが利用できない場合は、システム構成の問題を解決することを優先します。

### 判定方法: document-type-classifier サブエージェント

**複数PDFの並列判定により処理時間を短縮:**

**重要:** 1つのメッセージで複数のTaskツールを呼び出して並列実行します（ユーザー確認なし）。

各PDFについて:
- subagent_type: "document-type-classifier"
- prompt: PDFファイルパス（例: "/tmp/shiryou1.pdf"）を含む判定依頼
- 並列実行: 複数のTaskツール呼び出しを1つのメッセージに含める
- 結果: 各サブエージェントがJSON形式で判定結果を返す

例: 3つのPDFを並列判定する場合、1つのメッセージで3つのTaskツールを同時に呼び出す

### サブエージェントの出力形式

各サブエージェントは以下のJSON形式で判定結果を返します:

```json
{
  "file_path": "/tmp/shiryou1.pdf",
  "document_type": "powerpoint",
  "confidence": "high",
  "reason": "スライドタイトル、箇条書き記号が多数、体言止めの頻度が高い",
  "key_indicators": [
    "箇条書き記号の頻度: 高",
    "1ページあたりのトピック数: 1-2",
    "体言止めの頻度: 高"
  ],
  "page_count": 45
}
```

### 7つのカテゴリ

各PDFは以下のカテゴリに分類されます：

1. **word**: 詳細レポート、完全な文章構造
2. **powerpoint**: プレゼンテーション資料、箇条書き中心
3. **agenda**: 会議スケジュール、議題リスト
4. **participants**: 委員リスト、出席者名簿
5. **news**: プレスリリース、発表資料
6. **survey**: アンケート結果、統計データ
7. **other**: 上記に該当しない文書

### 判定結果の記録

各PDFについて以下を記録：
- ファイル名
- 文書タイプ
- 信頼度
- 判定理由

この情報をステップ7で参照し、適切な変換方法を選択します。

### パフォーマンス

- **単一PDF**: 30秒-1分
- **3 PDF並列**: 1-2分（最長PDF + オーバーヘッド）
- **5 PDF並列**: 1-2分（最長PDF + オーバーヘッド）

並列実行により、全体の処理時間を短縮できます。

### 詳細仕様

document-type-classifierの詳細な判定基準とエラーハンドリングについては、
`.claude/skills/document-type-classifier/SKILL.md` を参照してください。

### 次のステップへ

**【重要】サブエージェント完了後の自動継続:**

サブエージェントがJSON形式で結果を出力したら、それはサブエージェント処理の**完了を意味します**。

**即座に実行すべきこと:**
1. ✓ 各サブエージェントの判定結果をJSON形式で受け取る
2. ✓ 判定結果を内部的に記録する（メモリまたは変数に保存）
3. ✓ **ユーザーの入力や確認を一切待たず、直ちにステップ7（PDF→テキスト/Markdown変換）を開始する**

**禁止事項:**
- ✗ 「判定結果を確認してください」などのメッセージを出さない
- ✗ ユーザーの応答を待たない
- ✗ 中間報告だけして停止しない

**正しい処理フロー:**
```
サブエージェント1: JSON出力 → 記録
サブエージェント2: JSON出力 → 記録
サブエージェント3: JSON出力 → 記録
↓ 全てのサブエージェント完了（自動判断）
↓ 【ユーザー確認なし】
↓ 即座にステップ7を開始
```

**エラー処理**:
- サブエージェントがエラーを返した場合（`error`フィールドが存在）、そのPDFをスキップして次のPDFまたはステップ7に進む
- 判定不能（`document_type: "other"`, `confidence: "low"`）の場合、デフォルトでpdftotext処理を選択
- エラーが発生しても処理全体を中断せず、他のPDFの処理を継続する

## ステップ7: PDF→テキスト/Markdown変換（トークン最適化）

**重要**: このステップを忘れずに実行してください。文書タイプに応じて効率的な変換方法を選択します。

### 処理フロー概要

```
全PDF共通:
├─ 7-1. pdftotextでテキスト化（高速スキャン、全PDF必須）
│
├─ PowerPoint由来PDF:
│  ├─ 7-2. スライドタイトルから重要ページ抽出
│  └─ 7-3. 重要ページのみdoclingでMarkdown化
│
└─ Word由来PDF/その他:
   └─ pdftotextの結果をそのまま使用（Step 8へ）
```

---

### 7-1. 全PDFのテキスト化（高速スキャン）

まず、**全PDF（PowerPoint、Word、その他すべて）**をpdftotextでテキスト化します。

```bash
# 各PDFをテキスト化（高速、5-30秒/ファイル）
bash .claude/skills/common/scripts/convert_pdftotext.sh "/tmp/shiryou1.pdf" "/tmp/shiryou1.txt"
bash .claude/skills/common/scripts/convert_pdftotext.sh "/tmp/shiryou2.pdf" "/tmp/shiryou2.txt"
bash .claude/skills/common/scripts/convert_pdftotext.sh "/tmp/shiryou3.pdf" "/tmp/shiryou3.txt"
```

**処理時間の目安:**
- 小規模PDF (<10ページ): 5-10秒
- 中規模PDF (10-30ページ): 10-30秒
- 大規模PDF (30-50ページ): 30-60秒
- 非常に大規模PDF (>100ページ): 1-2分

**注意点:**
- pdftotextは多くのLinux環境に標準インストール
- 未インストールの場合: `apt-get install poppler-utils`
- 出力はプレーンテキスト（構造は後処理で判定）

**フォールバック（pdftotextが使えない場合）:**

```bash
# PyPDF2を使ったフォールバック
bash .claude/skills/common/scripts/convert_pdftotext_fallback.sh "/tmp/document.pdf" "/tmp/document.txt"

# PyPDF2も使えない場合、Read toolで直接読み取り
```

---

### 7-2. PowerPoint PDFの重要ページ抽出

**対象:** ステップ6でPowerPoint由来と判定されたPDFのみ

**目的:** 全ページをdocling変換すると時間がかかるため、重要なページのみを特定する

#### 処理手順:

```bash
# 1. テキストファイルを読んでスライドタイトルを抽出
#    Read tool で /tmp/shiryou1.txt を読み取る

# 2. 各ページの内容を分析して重要度を判定
#    - ページ区切り: pdftotextは "\f" (form feed) でページを区切る
#    - 各ページの最初の1-2行をスライドタイトルと見なす

# 3. 重要ページの判定基準:
#    【高優先度（必ず読む）】
#    - 背景・現状認識
#    - 課題・問題点
#    - 方向性・戦略
#    - 具体的施策・取組
#    - 予算・スケジュール
#    - 目標・KPI
#    - 実績・成果
#
#    【低優先度（スキップ）】
#    - 表紙（資料名のみ）
#    - 目次
#    - 参考資料
#    - 補足資料
#    - 用語集
#    - 組織図・名簿
#    - 免責事項・注記

# 4. 重要ページ番号をリスト化
#    例: [3, 4, 5, 6, 7, 10, 12, 15]  # 1始まり
```

#### 判定例:

| ページ | スライドタイトル（テキストの最初の行） | 判定 | 理由 |
|--------|--------------------------------------|------|------|
| 1 | 資料1-1 日本成長戦略の概要 | ✗ | 表紙 |
| 2 | 目次 | ✗ | 目次 |
| 3 | 1. 背景・現状認識 | ✓ | 現状認識 |
| 4 | 製造装置シェアの推移 | ✓ | データ・実績 |
| 5 | 2. 今後の方向性 | ✓ | 戦略・方向性 |
| 6 | 3つの重点施策 | ✓ | 具体的施策 |
| 7 | (1) デジタル投資の促進 | ✓ | 施策詳細 |
| ... | ... | ... | ... |
| 35 | 参考資料 | ✗ | 参考 |

**出力:** 重要ページ番号のリスト（例: `3,4,5,6,7,10,12,15`）

**目安:** 全50ページ中、重要ページは10-20ページ程度に絞る

---

### 7-3. PowerPoint PDFの部分Markdown化

**対象:** 7-2で抽出した重要ページのみ

**ツール:** docling container（スライド構造を保持するため）

#### docling-serve containerの準備

```bash
# 初回のみ: コンテナをpullして起動
docker pull quay.io/docling-project/docling-serve
docker run -d -p 5001:5001 --name docling-server quay.io/docling-project/docling-serve

# 既に起動済みか確認
docker ps | grep docling
```

#### 重要ページのみMarkdown化

**アプローチ:** doclingはページ範囲指定に対応していないため、全ページ変換後に重要ページのみ抽出

```bash
# 1. PDF全体を非同期で変換（並列処理のため、複数PDFを同時投入可能）
TASK_ID=$(bash .claude/skills/common/scripts/docling_convert_async.sh "/tmp/shiryou1.pdf")

# 2. 変換完了を待機（ポーリング、15秒ごとにチェック）
bash .claude/skills/common/scripts/docling_poll_status.sh "$TASK_ID"

# 3. 結果を取得してMarkdownファイルに保存
bash .claude/skills/common/scripts/docling_get_result.sh "$TASK_ID" "/tmp/shiryou1_full.md"

# 3.5. 画像を別ファイルに抽出してMarkdownから削除（重要！）
# doclingは画像をbase64エンコードで埋め込むため、ファイルサイズが巨大になる
# 後続処理のために画像を抽出して別ファイルに保存し、Markdownからは削除する
bash .claude/skills/common/scripts/extract_images_from_md.sh "/tmp/shiryou1_full.md"

# 4. 重要ページのみ抽出
# 重要ページ番号（7-2で特定したもの）: 例 3,4,5,6,7,10,12,15
bash .claude/skills/common/scripts/extract_important_pages.sh "/tmp/shiryou1_full.md" "/tmp/shiryou1.md" "3,4,5,6,7,10,12,15"
```

**処理時間の目安:**
- docling変換（全ページ）: 3-8分（ページ数による）
- 重要ページ抽出: 10-30秒
- **合計（PowerPoint PDF）:** 約4-10分/ファイル

**並列処理:** 複数のPowerPoint PDFがある場合、docling変換を並列実行可能（全て非同期で投入→全て完了待ち）

---

### 処理方法の最終判断フロー

```
Step 6の判定結果に基づく:

├─ PowerPoint由来PDF
│  ├─ 7-1: pdftotext でテキスト化（全ページ、高速）
│  ├─ 7-2: スライドタイトル分析→重要ページ抽出
│  └─ 7-3: docling で重要ページのみMarkdown化
│      ├─ 成功 → 部分Markdown使用（Step 8へ）
│      └─ 失敗 → pdftotextの全文テキスト使用（Step 8へ）
│
├─ Word由来PDF
│  └─ 7-1: pdftotext でテキスト化
│      ├─ 成功 → テキストファイル使用（Step 8へ）
│      └─ 失敗 → Read toolで直接読み取り（Step 8へ）
│
└─ その他（議事次第、名簿、調査など）
   └─ 7-1: pdftotext でテキスト化
       ├─ 成功 → テキストファイル使用（Step 8へ）
       └─ 失敗 → Read toolで直接読み取り（Step 8へ）
```

---

### 処理時間の比較

| 文書タイプ | 処理内容 | 時間 |
|-----------|---------|------|
| Word PDF (30ページ) | pdftotext のみ | 30秒 |
| PowerPoint PDF (50ページ) | pdftotext + 重要ページ抽出 + docling部分変換 | 5-8分 |
| その他 PDF (10ページ) | pdftotext のみ | 10秒 |

**効率化のポイント:**
- Word/その他は高速処理（pdftotextのみ、数十秒）
- PowerPoint のみ時間がかかる（docling使用、数分）
- 複数PowerPoint PDFは並列処理可能（同時に非同期変換）

---

### エラーハンドリング

**ツールチェック:**
```bash
# pdftotext が利用可能か確認
bash .claude/skills/common/scripts/check_tool.sh pdftotext
# 終了コード: 0=利用可能, 1=利用不可

# pdftotextが使えない場合、PyPDF2フォールバックを試す
bash .claude/skills/common/scripts/convert_pdftotext_fallback.sh "/tmp/document.pdf" "/tmp/document.txt"

# PyPDF2も使えない場合、Read toolで直接PDFを読む
```

**docling変換のエラーハンドリング:**
- convert_pdftotext.sh: pdftotextが見つからない場合、エラーで終了
- convert_pdftotext_fallback.sh: PyPDF2がない場合、エラーで終了
- docling_convert_async.sh: TASK_IDが取得できない場合、エラーで終了
- docling_poll_status.sh: 10分以内に完了しない場合、タイムアウトエラー
- docling_get_result.sh: 結果が取得できない場合、エラーで終了

これらのエラーが発生した場合は、pdftotextの全文テキストまたはRead toolで読み取ったPDFを使用してStep 8に進みます。


## ステップ8: 資料の読み取りと分析（トークン最適化）

**前提:** ステップ7で変換したファイル（テキストファイルまたはMarkdownファイル）を読み取る

### 前提条件チェック: サブエージェント利用可能性

**重要**: このステップを開始する前に、`material-analyzer`サブエージェントが利用可能かを確認する必要があります。

**利用可能性の判定基準:**
- Skillツールの利用可能なスキルリストに`material-analyzer`が含まれている
- サブエージェントのSKILL.mdに適切なYAMLフロントマターが設定されている

**サブエージェントが利用できない場合の処理:**
1. **エラーメッセージを表示**:
   ```
   【エラー】material-analyzerサブエージェントが利用できません。

   原因:
   - サブエージェントのSKILL.mdにYAMLフロントマターがない
   - allowed-toolsの設定が不足している
   - Claude Codeの設定に問題がある

   対処方法:
   1. .claude/skills/material-analyzer/SKILL.mdを確認
   2. YAMLフロントマター（name, description, allowed-tools）が正しく設定されているか確認
   3. Claude Codeセッションを再起動

   サブエージェントが利用できない状態では、並列処理の利点が失われ、
   処理時間が大幅に増加するため、処理を中断します。
   ```

2. **処理を終了**: レポート生成を中断し、ユーザーに修正を促す

**注意**: 代替処理（ファイルを直接読んで分析）は実装しません。サブエージェントが利用できない場合は、システム構成の問題を解決することを優先します。

### 分析方法: material-analyzer サブエージェント

**複数資料の並列分析により処理時間を大幅短縮:**

**重要:** 1つのメッセージで複数のTaskツールを呼び出して並列実行します（ユーザー確認なし）。

各資料について:
- subagent_type: "material-analyzer"
- prompt: ファイルパス、文書タイプ、優先度スコア、メタデータJSONを含む分析依頼
- 並列実行: 複数のTaskツール呼び出しを1つのメッセージに含める
- 結果: 各サブエージェントがJSON形式で分析結果を返す

例: 3つの資料を並列分析する場合、1つのメッセージで3つのTaskツールを同時に呼び出す

各サブエージェントへの入力例:
- ファイルパス: "/tmp/shiryou1.md"
- 文書タイプ: "powerpoint"
- 優先度スコア: "5"
- メタデータJSON: '{"title":"資料1-1","filename":"shiryou1-1.pdf","url":"https://...","page_count":45}'

### サブエージェントの入力

各サブエージェントには以下の引数を渡します:

1. **file_path**: 変換済みファイルのパス（`.md` または `.txt`）
2. **document_type**: ステップ6で判定した文書タイプ（`word` / `powerpoint` / etc）
3. **priority_score**: ステップ5で算出した優先度スコア（1-5）
4. **metadata_json**: 資料のメタデータ（JSON文字列）

### サブエージェントの出力形式

各サブエージェントは以下のJSON形式で分析結果を返します:

```json
{
  "file_path": "/tmp/shiryou1.md",
  "title": "資料1-1 日本成長戦略の概要",
  "document_type": "powerpoint",
  "analysis": {
    "summary": "本資料は、日本の中長期的な成長戦略を示したものである。現状認識として...",
    "key_points": [
      "現状認識: 日本の製造装置シェアが26%から16%に縮小",
      "方向性: デジタル・エコシステムの実現を目指す",
      "予算: 2030年度までに10兆円規模の支援"
    ],
    "structure": [
      {"section": "背景・現状認識", "pages": "1-5"},
      {"section": "今後の方向性", "pages": "6-15"}
    ],
    "reading_strategy": "powerpoint_medium",
    "tokens_estimated": 15000
  },
  "metadata": {
    "filename": "shiryou1-1.pdf",
    "url": "https://www.cas.go.jp/.../shiryou1-1.pdf",
    "page_count": 45
  }
}
```

### 文書タイプ別の読み取り戦略

material-analyzerは、文書タイプとファイルサイズに基づいて最適な戦略を自動選択します:

#### Word文書

```
行数 <= 500行:     全文読み取り
行数 <= 2000行:    目次 + 重要セクション
行数 <= 5000行:    目次 + 概要 + 結論
行数 > 5000行:     メタデータ + 目次 + 概要のみ
```

#### PowerPoint文書

```
ページ数 <= 5:     全スライド読み取り
ページ数 <= 20:    目次 + 重要スライド
ページ数 <= 50:    目次 + 概要 + 結論スライド
ページ数 > 50:     目次 + 概要スライドのみ
```

#### その他

- 議事次第: 全文読み取り（通常短い）
- 参加者名簿: スキップまたは簡単な記述
- ニュース: 全文読み取り
- 調査: 目次 + 主要な図表のみ

### 結果の統合

全てのサブエージェントが完了したら、各分析結果を統合して次のステップ（要約生成）に渡します。

### パフォーマンス

- **単一資料**: 2-5分（サイズによる）
- **3資料並列**: 3-6分（最長資料 + オーバーヘッド）
- **5資料並列**: 4-8分（最長資料 + オーバーヘッド）

並列実行により、**処理時間を30-50%短縮**できます。

### 詳細仕様

material-analyzerの詳細な読み取り戦略、セクション優先度、エラーハンドリングについては、
`.claude/skills/material-analyzer/SKILL.md` を参照してください。

### 次のステップへ

**【重要】サブエージェント完了後の自動継続:**

サブエージェントがJSON形式で分析結果を出力したら、それはサブエージェント処理の**完了を意味します**。

**即座に実行すべきこと:**
1. ✓ 各サブエージェントの分析結果をJSON形式で受け取る
2. ✓ 分析結果を統合して内部的に記録する
3. ✓ **ユーザーの入力や確認を一切待たず、直ちにステップ9（要約の生成）を開始する**

**禁止事項:**
- ✗ 「分析結果を確認してください」などのメッセージを出さない
- ✗ ユーザーの応答を待たない
- ✗ 中間報告だけして停止しない

**正しい処理フロー:**
```
material-analyzer 1: JSON出力 → 記録
material-analyzer 2: JSON出力 → 記録
material-analyzer 3: JSON出力 → 記録
↓ 全てのサブエージェント完了（自動判断）
↓ 【ユーザー確認なし】
↓ 即座にステップ9を開始（アブストラクト生成）
```

**エラー処理**:
- サブエージェントがエラーを返した場合（`error`フィールドが存在）、その資料をスキップして次の資料または次のステップに進む
- 空コンテンツ（`summary: ""`, `key_points: []`）の場合、その資料は「内容なし」として記録し、次の資料に進む
- エラーが発生しても処理全体を中断せず、他の資料の処理を継続する

## ステップ9: 要約の生成

### report.md の構成
**全体構成**:
```markdown
# {会議名}（第X回）

- **開催日時**: YYYY年MM月DD日（曜日）HH:MM～HH:MM
- **開催場所**: {場所}

## アブストラクト

```
{アブストラクト本文: 1,000字以内}
{元のURL}
```

## 配布資料一覧
- 議事次第: {ファイル名}
- 資料1: {資料名} - {ファイル名}
- 資料2: {資料名} - {ファイル名}
- ...

## 基本情報
- **会議名**: {正式名称}
- **開催日時**: YYYY年MM月DD日（DAY）HH:MM～HH:MM
- **開催場所**: {詳細な場所}
- **主催**: {組織名}

## 議事次第
{議事次第の内容}

## 会議概要
{HTMLまたは議事次第から抽出した概要}

## 議事録
{実際の発言内容がある場合のみ記載}
{発言者と主要な発言内容}

## 配布資料の詳細

### 1. {資料名}
- **ファイル名**: {filename.pdf}
- **URL**: {絶対URL}
- **文書タイプ**: Word/PowerPoint/議事次第/etc.
- **ページ数**: {N}ページ
- **要約**:
  {資料の詳細な要約}

  **主要ポイント**:
  - {ポイント1}
  - {ポイント2}

### 2. {資料名}
...

## まとめ
{全体を通した重要事項のまとめ}

## 参考リンク
- 会議ページ: {元のURL}
- 議事録・発言: {URLがあれば}
```

### アブストラクトの形式（1,000字以内）

論文のabstractと同様の構造化された要約を作成する：

**必須要素（この順序で記述）:**

1. **【背景・文脈】** (2-3文)
   - **会議名と回数を必ず含める**（例:「第X回○○会議は」）
   - なぜこの会議が開催されたか
   - 現在の社会的・政策的文脈
   - 前回からの経緯（第2回以降の場合）

2. **【目的】** (1-2文)
   - 本会議の目的・狙い
   - 検討対象となる課題

3. **【議論内容】** (3-5文)
   - 主要な議題
   - 各議題で議論された論点
   - 提出された資料の概要
   - **重要**: 抽象的な「議論された」ではなく、資料に含まれる具体的な内容を記述
     （現状認識、方向性、ロードマップ、予算、論点など）

4. **【決定事項・合意内容】** (3-5文)
   - 具体的な決定事項
   - 予算措置、制度改正、政策方針など
   - 数値目標や期限があれば明記

5. **【今後の方針】** (2-3文)
   - 次のステップ
   - 担当部署への指示事項
   - 今後のスケジュール

**記述スタイル:**
- **1段落のみで構成**（改行なし）
- 簡潔で客観的な記述
- 1文は50-80文字程度
- 専門用語は必要最小限に
- 5つの要素を自然な文の流れで繋げる
- 接続詞を効果的に使い、論理的な展開を維持
- **アブストラクト段落の直後に、元のURLを改行して記載する**

**制約**:
- **アブストラクト全体で1,000字以内**（厳守）
- 提供された資料に実際にある内容のみ使用（推測・補足・創作禁止）
- メタデータ除外: ファイルサイズ、ソフトウェア要件、タイムスタンプ
- 宣言型で記述（「では」の重複を避ける）
- 議事録がない場合: 「議論の詳細は記録されていない」と明記

**アブストラクト例:**

## アブストラクト

```
第2回日本成長戦略会議は、日本経済の中長期的な成長を実現するための包括的な戦略を検討する場として設置され、前回会議では基本方針が確認されたが、今回は具体的な実行体制の構築が課題となっていた。本会議の目的は、17の戦略分野と8つの分野横断的課題について、官民が連携する検討体制を確立することである。会議では、成長戦略の検討体制と分野横断的課題への対応方向性が議題として取り上げられ、検討体制については各分野における官民の役割分担と連携の仕組みが提案され、分野横断的課題については労働市場改革、デジタル化、グリーン化などの重点領域が示された。具体的な決定事項として、本年度補正予算で6.4兆円の予算措置を講じることが確定し、このうち造船能力向上のための10年基金が創設され、複数年度にわたる継続的な支援体制が確保されることとなった。また、令和8年度税制改正大綱において、全業種を対象とした大胆な投資促進税制が導入され、建物を含む高付加価値設備投資に対して即時償却または税額控除7%を選択できる制度により、年間約4兆円の投資が見込まれている。今後の方針として、総理は担当大臣に対し官民投資ロードマップの策定を指示し、特に労働市場改革では心身の健康維持と従業者の選択を前提とした柔軟な働き方の実現を推進するとともに、家事支援サービスの公的資格化を加速し、女性の社会進出を支援する環境整備を進めることとした。
https://www.cas.go.jp/jp/seisaku/nipponseichosenryaku/kaigi/dai2/gijisidai.html
```

（上記例: 約590字、1段落 + URL）

**制約**:
- report.mdは将来のコンテキスト参照用として詳細に記述
- ただし全体で10,000字を超えないように調整
- アブストラクトは必ずコードフェンス（\`\`\`）で囲む（抽出可能にするため）
- 全てのPDFリンクは絶対URLで記載

## ステップ10: ファイル出力

### ディレクトリ構造
```
output/
└── {会議名}_{回数}_{日付}_report.md
```

例:
```
output/
└── 日本成長戦略会議_第2回_20251224_report.md
```

### 実装手順
1. `./output` ディレクトリを作成（存在しなければ）
2. Writeツールで1つのファイルを直接 `./output/` に作成
3. 完了メッセージを表示

**重要**: アブストラクトは必ずコードフェンス（\`\`\`）で囲んで記述し、プログラムで抽出可能にすること

## ステップ11: Bluesky投稿

### 目的
生成したアブストラクトをBlueskyに自動投稿し、会議情報を広く共有する。

### スキルの使用

**【重要】必ず専用スクリプトを使用してください:**

このステップでは、[bluesky-postスキル](../bluesky-post/SKILL.md)の専用スクリプトを**必ず**使用します。

```bash
# 【必須】生成されたレポートファイルを引数に指定して専用スクリプトを実行
bash .claude/skills/bluesky-post/post.sh "./output/{会議名}_{回数}_{日付}_report.md"
```

**禁止事項:**
- ✗ awkやcatを直接使ってアブストラクトを抽出しない
- ✗ ssky postを直接呼び出さない
- ✗ 独自のスクリプトを記述しない

**理由:**
- 専用スクリプトにはエラーハンドリング、ログイン確認、抽出ロジックが統合されている
- コードフェンス内のテキスト抽出は複雑で、awkの誤用によりアブストラクトが空になる可能性がある
- すべてのpagereportスキルで統一された動作を保証する

### 処理フロー

bluesky-postスキルは以下の処理を自動的に実行します：

1. **事前確認**: sskyコマンドの存在確認、ログイン状態確認
2. **アブストラクト抽出**: awkでコードフェンス内のテキストを `/tmp/abstract.txt` に抽出
3. **投稿準備**: アブストラクト + URL を `/tmp/post.txt` に準備
4. **投稿実行**: `cat /tmp/post.txt | ssky post` で投稿（長いテキストは自動的にスレッド分割）
5. **結果表示**: 投稿成功/失敗のメッセージを表示

**実装のメリット**:
- スクリプトファイル化により、複数行の読みやすいシェルスクリプトとして記述
- エラーハンドリングが充実（set -e によるエラー時即座終了）
- 各ステップで内容を確認でき、デバッグが容易
- 全pagereportスキルで共通のロジックを使用

### エラーハンドリング

このステップは**非クリティカル**です。以下の場合、警告メッセージを表示してスキップします：

- sskyコマンドがインストールされていない
- Blueskyにログインしていない
- アブストラクトの抽出に失敗
- 投稿に失敗

**重要**: 投稿が失敗してもレポート生成（ステップ10）には影響しません。

### 実装の注意点

- **必須**: ステップ10でファイル出力が完了した後に実行
- **非破壊的**: 投稿失敗してもレポートファイル生成には影響しない
- **ユーザー通知**: 投稿成功/失敗を明確にメッセージ表示
- **スキップ可能**: sskyがない、またはログインしていない場合は警告のみでスキップ（exit 0）

### 詳細

投稿スクリプトの実装詳細については、[bluesky-postスキルのドキュメント](../bluesky-post/SKILL.md)およびスクリプトファイル[post.sh](../bluesky-post/post.sh)を参照してください。

手動で投稿する場合は、`.claude/commands/bluesky-post.md`コマンドを使用することもできます。

# エラーハンドリング

1. **HTML取得失敗時**:
   - HTML再取得を試行
   - 正規化処理を実行
   - 再試行
   - 各段階でログ記録

2. **PDFダウンロード失敗時**:
   - curl のエラーメッセージを記録
   - そのPDFをスキップして次へ進む
   - 最低限の情報（ファイル名、URL）は detail.md に記載

3. **PDF読み取り失敗時**:
   - Read ツールのエラーを記録
   - そのPDFの内容は「読み取り不可」として記載

4. **日付・回数が取得できない場合**:
   - ユーザーに入力を求める

# 注意事項

- トークン消費を最小化するため、全文を読まず構造的アプローチを採用
- 推測や創作は絶対に行わず、実際にある情報のみを使用
- 議事録がない場合も明示的に記載
- 参考資料や名簿など本質的でない資料は読まない
