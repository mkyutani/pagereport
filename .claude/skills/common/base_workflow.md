# 政府会議ページサマリー作成 - 共通ワークフロー

このドキュメントは、政府会議ページのサマリー作成スキルで使用される共通の処理フローを定義しています。
各府省庁スキル（pagereport-cas, pagereport-cao, pagereport-meti）はこのワークフローを参照します。

---

# 引数

- URL（HTMLページまたはPDFファイル）
  - 会議名はHTMLから自動的に抽出されます

# 出力仕様

1つのファイルを生成:
- `output/{会議名}_{回数}_{日付}_report.md` - サマリーと詳細を統合したレポート

**report.md の構成:**
- 基本情報（会議名、日時、場所）
- **アブストラクト（1,000字以内）**: 論文のabstract形式で構造化された要約（コードフェンスで囲む）
- 配布資料一覧
- 詳細な会議情報（議事次第、会議概要、議事録）
- 各資料の要約と主要ポイント
- 全体のまとめ
- 参考リンク

# 処理フロー

## ステップ1: コンテンツ取得とクリーニング

### HTMLページの場合
1. WebFetchでページを取得
2. **不要要素を削除**:
   - ヘッダー（ページ上部のナビゲーション、ロゴ、検索ボックス）
   - フッター、サイドバー、パンくずリスト
   - 広告、補助的なコンテンツ
3. **保持する要素**:
   - 会議録、報告書、議事次第、重要な決定事項
   - 本質的なコンテンツ（見出し、リスト、表、リンク）

### PDFの場合（ローカルファイル）
1. Readツールで直接読み取り

### PDFの場合（リモートURL）
1. 後述のステップ6-4でダウンロードしてから読み取り

## ステップ2: メタデータ自動抽出

HTMLまたはPDFから以下を抽出:
- **会議名**: ページタイトル、h1要素、またはPDFタイトルから正式名称を抽出
  - 例: 「日本成長戦略会議」「成長戦略会議」など
  - HTMLの場合: `<title>` タグ、`<h1>` タグ、パンくずリストから抽出
  - PDFの場合: メタデータまたは1ページ目のタイトルから抽出
- **開催日時**: 「令和X年Y月Z日」→ YYYYMMDD形式に変換
- **回数**: 「第X回」を抽出
- **開催場所**
- **議事内容**（概要）

会議名、日付、回数が取得できない場合は、ユーザーに確認する。

## ステップ3: 文書タイプの判定

PDFを読み取る際、最初の1-10ページを分析して文書タイプを判定（1-5点でスコアリング）:

### 7つのカテゴリ
1. **Word**: 連続した長い段落、明確な文章構造（主語・述語）
2. **PowerPoint**: 箇条書き、各ページにスライドタイトル、体言止め
3. **議事次第**: 会議のアジェンダ
4. **参加者名簿**: 委員リスト
5. **ニュース**: プレスリリース、発表資料
6. **調査**: データや統計資料
7. **その他**

**重要**: PowerPointはWordとして誤判定されやすい。箇条書き、短いフレーズ、スライドタイトル、体言止めに注意。

## ステップ4: 会議概要の作成

### パターンA: HTMLに概要が記載されている場合
- HTML本文から抽出

### パターンB: 「議事次第」PDFがある場合
- 議事次第PDFから以下を抽出:
  - 会議名、日付、場所
  - 主要議題項目

## ステップ5: 議事録の参照

### 3つのパターン
1. **HTML本文に議事録あり**: HTML本文から抽出
2. **議事録PDFあり**: 議事録PDFから実際の発言内容を抽出
3. **いずれも存在しない**: スキップ

**検証**: 実際の参加者の発言が含まれているか確認（「○○大臣」「○○委員」など）

## ステップ6: 資料の選択的読み取り

### 6-1. PDFリンクの検出と絶対URL化
HTMLから全PDFリンクを抽出し、相対パスを絶対URLに変換。

### 6-2. 資料の優先度判定（1-5点スコアリング）

各資料を以下の基準で評価:
- 要約への関連性
- 内容の重要性
- 文書タイプ
- 時系列的位置

**重要な調整ルール**:
1. ✓ 実質的な資料がある場合、議事次第に最高スコア(5)を与えない
2. ✓ 参考資料と通常資料が両方ある場合、参考資料は最大4点まで
3. ✓ 概要と全文が両方ある場合 → 概要優先、全文スコアを1段階下げる
4. ✓ **除外対象**: 委員名簿、座席表、公開方法
5. ✓ **個人名・団体名の資料**（取組資料）の扱い:
   - 「○○委員」「○○教授」など個人名が含まれる資料
   - 企業名、社団法人名、財団法人名などが含まれる資料
   - これらは各委員・団体が提出した取組資料と推測される
   - **原則**: 事務局資料（Executive Summary、とりまとめ、概要、戦略等）がある場合、
     個人名・団体名の資料は読む対象にしない（スコア1-2程度の低優先度）
   - **例外**: 事務局資料がなく、議事次第・委員名簿以外に個人名・団体名の資料しかない場合、
     これらを読んで簡潔にまとめる

**ファイル名パターン認識**:
- **高優先度**: `shiryou1.pdf`, `shiryou2.pdf`（番号が若い）、`honpen.pdf`、`gaiyou.pdf`
- **低優先度**: `sankou*.pdf`（参考）、`betshi*.pdf`（別紙）、`meibo.pdf`（名簿）

**議事録での言及度分析**:
- 具体的言及（「資料X」「XX大臣説明資料」） → 重要度+2
- 間接的言及（「詳細は資料参照」） → 重要度+1
- 言及なし → 重要度-1

### 6-3. 上位資料のみ選択
スコア上位の資料のみを選択（目安: 上位3-5個、または スコア4以上）

### 6-3b. 重点資料の詳細な内容抽出

**重点的に読むべき資料タイプ**:

以下のような資料は会議の主要な議論内容が含まれているため、
詳細に読み取り、**具体的な内容**をサマリーに反映すること：

- Executive Summary / エグゼクティブサマリー
- とりまとめ資料
- 概要資料
- 戦略資料 / ○○戦略
- 方針資料 / 今後の方向性
- 中間報告 / 最終報告

**経産省等の事務局資料の典型的な構成要素**:

議題と資料表題に基づいて、以下の要素のうち資料に含まれているものを
抽出してサマリーに反映すること：

1. **現状認識**
   - 国内の状況（市場動向、産業動向、技術動向、課題）
   - 海外の状況（諸外国の政策、国際競争環境、海外企業の動向）

2. **あるべき姿・方向性**
   - 目指すべき状態
   - 政策の基本的な方向性
   - 戦略的な考え方

3. **ロードマップ**
   - 時系列での取り組み
   - マイルストーン
   - 技術開発の見通し

4. **予算の考え方**
   - 支援の規模・スキーム・財源

5. **論点**
   - 検討すべき課題
   - 政策オプション
   - 今後の検討事項

**記述の原則**:
- 議題と資料表題に沿って、議論されたと想定される**具体的な内容**を記述
- 「議論された」「検討された」のみの抽象的表現は避ける
- 資料に含まれる上記の構成要素を具体的に抽出して記述する

**記述例**:
- ❌ 抽象的: 「戦略の方向性について議論された」
- ✅ 具体的: 「現状認識として日本の製造装置シェア縮小（26%→16%）が指摘され、今後の方向性としてデジタル・エコシステムの実現が示され、予算として2030年度までに10兆円規模の支援が提示された」

### 6-4. PDFのダウンロード（重要）

**リモートPDFの取得方法:**

選択した高優先度PDFを curl でダウンロード:

```bash
# 各PDFをダウンロード
curl -o /tmp/shidai.pdf "https://example.com/shidai.pdf"
curl -o /tmp/shiryou1-1.pdf "https://example.com/shiryou1-1.pdf"
# ... 他の優先度の高いPDFも同様に
```

**ポイント:**
- `/tmp/` ディレクトリに保存（一時ファイル）
- ファイル名は元のファイル名を維持
- ダウンロード失敗時はエラーをログして次へ進む
- 並列ダウンロードは避ける（順次実行）

### 6-5. docling containerでPDF→Markdown変換（トークン最適化）

**重要**: PDFを直接Read toolで読むとトークンを大量に消費します。docling containerでMarkdownに変換してから読むことで、トークン消費を大幅に削減できます。

#### docling-serve containerの準備

```bash
# CPU-only版のコンテナをpullして起動（初回のみ）
docker pull quay.io/docling-project/docling-serve
docker run -d -p 5001:5001 --name docling-server quay.io/docling-project/docling-serve

# コンテナの状態確認
docker ps | grep docling
```

#### PDFからMarkdownへの変換

**変換方法の選択:**

- **同期処理**: 小規模PDF (<10ページ推定) のみ使用可能（120秒タイムアウト制限）
- **非同期処理**: 中〜大規模PDF (>10ページ) で必須、複数PDF処理時に推奨

**方法1: 非同期処理（推奨、複数PDF対応）**

```bash
# 1. 全PDFを非同期で投入（並行処理）
TASK_ID_1=$(curl -s -X POST http://localhost:5001/v1/convert/file/async \
  -F "files=@/tmp/shiryou1.pdf" | \
  python3 -c "import json, sys; print(json.load(sys.stdin)['task_id'])")

TASK_ID_2=$(curl -s -X POST http://localhost:5001/v1/convert/file/async \
  -F "files=@/tmp/shiryou2.pdf" | \
  python3 -c "import json, sys; print(json.load(sys.stdin)['task_id'])")

# 2. 各タスクの完了を待機（ポーリング）
for TASK_ID in $TASK_ID_1 $TASK_ID_2; do
  while true; do
    STATUS=$(curl -s "http://localhost:5001/v1/status/poll/$TASK_ID" | \
      python3 -c "import json, sys; print(json.load(sys.stdin)['task_status'])")
    if [ "$STATUS" = "success" ]; then
      break
    fi
    sleep 15  # 15秒ごとにチェック
  done
done

# 3. 結果を取得してMarkdownファイルに保存
curl -s "http://localhost:5001/v1/result/$TASK_ID_1" | \
  python3 -c "import json, sys; print(json.load(sys.stdin)['document']['md_content'])" \
  > /tmp/shiryou1.md

curl -s "http://localhost:5001/v1/result/$TASK_ID_2" | \
  python3 -c "import json, sys; print(json.load(sys.stdin)['document']['md_content'])" \
  > /tmp/shiryou2.md
```

**処理時間の目安:**
- 小規模PDF (<10ページ): 1-2分
- 中規模PDF (10-30ページ): 3-5分
- 大規模PDF (30-50ページ): 5-8分
- 複数PDF並行処理: 最長PDFの時間 + 1-2分

**方法2: 同期処理（小規模PDFのみ）**

```bash
# 小規模PDFのみ使用可能（120秒タイムアウトあり）
curl -s -X POST http://localhost:5001/v1/convert/file \
  -F "files=@/tmp/small.pdf" | \
  python3 -c "import json, sys; print(json.load(sys.stdin)['md_content'])" \
  > /tmp/small.md

# タイムアウトエラー ("Conversion is taking too long") が発生した場合は、
# 方法1の非同期処理に切り替える
```

#### Markdown読み取り

変換後、Read toolでMarkdownファイルを読み取ります：

```bash
# 通常の読み取り
Read /tmp/shiryou1.md

# ファイルサイズが大きい場合（>256KB、base64画像含む）:
# Grepで見出しを抽出して構造を把握
grep "^#{1,3}\s+" /tmp/shiryou1.md

# 構造把握後、必要なセクションのみ読む
```

#### docling vs Read toolの使い分け

**docling containerを使うべき場合:**
- ✓ 大きなPDF（50ページ超）でトークン削減効果が期待できる
- ✓ 表やレイアウトが複雑な文書（構造化されたMarkdownで読みやすくなる）
- ✓ OCRが必要なスキャンPDF

**Read toolを直接使うべき場合:**
- ✓ 小さなPDF（20ページ以下）- 変換オーバーヘッドが大きい
- ✓ シンプルなテキスト主体の文書
- ✓ dockerが利用できない環境

**注意点:**
- docling containerは初回起動時にAIモデルのダウンロードが発生（数分）
- 変換処理には時間がかかる（大きなPDFで1-3分程度）
- コンテナが起動していない場合は変換がエラーになる
- 変換失敗時はRead toolで直接PDFを読むフォールバック処理を実装

#### エラーハンドリング

```bash
# コンテナが起動しているか確認
if ! docker ps | grep -q docling-server; then
    echo "docling container not running, using Read tool instead"
    # Read toolで直接PDFを読む処理へフォールバック
fi
```

## ステップ7: 文書タイプ別の効率的読み取り（トークン最適化）

**前提:** ステップ6-4でダウンロードしたローカルPDFを Read ツールで読み取る

### ページ数による動的戦略
```
ページ数 <= 5:     全文読み取り
ページ数 <= 20:    目次 + 重要セクション
ページ数 <= 50:    目次 + 概要 + 結論
ページ数 > 50:     メタデータ + 目次 + 概要のみ
```

### Word文書の処理
1. **Read ツールでPDF全体を読み取り**（最初の1-10ページで文書タイプ判定）
2. 最初の5ページからタイトル抽出
3. 最初の10ページから目次抽出
4. **「概要」「要旨」「まとめ」セクションがあれば優先的に読む**
5. 目次構造から本質的なセクションのみ選択
6. 選択セクションから要約作成

**トークン節約:**
- ページ数が多い場合（50ページ超）は、limit/offset パラメータで分割読み取り
- 目次で重要セクションのページ番号を特定してから該当ページのみ読む

### PowerPoint文書の処理
1. **Read ツールでPDF全体を読み取り**（最初の1-10ページで文書タイプ判定）
2. 最初の3ページからタイトル抽出
3. **全スライドのタイトルを20ページごとにバッチ処理で抽出**
4. 各スライドを重要度スコアリング（1-5点）
5. 高スコアスライド + タイトル関連コンテンツのみ詳細読み取り
6. 選択スライドから要約作成

**トークン節約:**
- スライド総数が多い場合は、最初に limit/offset で全スライドタイトルのみ取得
- 重要スライドのページ番号を特定してから該当ページを再読み取り

### Excel由来PDFの処理
1. **Read ツールでPDFを読み取り**
2. データ表/グラフのタイトル、軸ラベルのみ抽出
3. 数値データの詳細は読まない（トークン節約）

### セクション優先度マッピング
**優先度【高】** - 必ず読む:
- 「概要」「要旨」「サマリー」「エグゼクティブサマリー」
- 「まとめ」「結論」「今後の方針」
- 「主要な決定事項」「ポイント」「重点事項」

**優先度【中】** - 必要に応じて読む:
- 「背景」「目的」「経緯」「課題」

**優先度【低】** - スキップ:
- 「参考」「補足」「附属資料」「詳細データ」

### 空コンテンツの検出
以下の場合は空文字列を返す（無駄な説明を避ける）:
- 表紙のみ（タイトルと日付だけ）
- 画像のみのページ → キャプションがあれば抽出
- データ表のみ → 表タイトル + 列ヘッダーのみ抽出

## ステップ8: 要約の生成

### report.md の構成
**全体構成**:
```markdown
# {会議名}（第X回）

- **開催日時**: YYYY年MM月DD日（曜日）HH:MM～HH:MM
- **開催場所**: {場所}

## アブストラクト

```
{アブストラクト本文: 1,000字以内}
{元のURL}
```

## 配布資料一覧
- 議事次第: {ファイル名}
- 資料1: {資料名} - {ファイル名}
- 資料2: {資料名} - {ファイル名}
- ...

## 基本情報
- **会議名**: {正式名称}
- **開催日時**: YYYY年MM月DD日（DAY）HH:MM～HH:MM
- **開催場所**: {詳細な場所}
- **主催**: {組織名}

## 議事次第
{議事次第の内容}

## 会議概要
{HTMLまたは議事次第から抽出した概要}

## 議事録
{実際の発言内容がある場合のみ記載}
{発言者と主要な発言内容}

## 配布資料の詳細

### 1. {資料名}
- **ファイル名**: {filename.pdf}
- **URL**: {絶対URL}
- **文書タイプ**: Word/PowerPoint/議事次第/etc.
- **ページ数**: {N}ページ
- **要約**:
  {資料の詳細な要約}

  **主要ポイント**:
  - {ポイント1}
  - {ポイント2}

### 2. {資料名}
...

## まとめ
{全体を通した重要事項のまとめ}

## 参考リンク
- 会議ページ: {元のURL}
- 議事録・発言: {URLがあれば}
```

### アブストラクトの形式（1,000字以内）

論文のabstractと同様の構造化された要約を作成する：

**必須要素（この順序で記述）:**

1. **【背景・文脈】** (2-3文)
   - **会議名と回数を必ず含める**（例:「第X回○○会議は」）
   - なぜこの会議が開催されたか
   - 現在の社会的・政策的文脈
   - 前回からの経緯（第2回以降の場合）

2. **【目的】** (1-2文)
   - 本会議の目的・狙い
   - 検討対象となる課題

3. **【議論内容】** (3-5文)
   - 主要な議題
   - 各議題で議論された論点
   - 提出された資料の概要
   - **重要**: 抽象的な「議論された」ではなく、資料に含まれる具体的な内容を記述
     （現状認識、方向性、ロードマップ、予算、論点など）

4. **【決定事項・合意内容】** (3-5文)
   - 具体的な決定事項
   - 予算措置、制度改正、政策方針など
   - 数値目標や期限があれば明記

5. **【今後の方針】** (2-3文)
   - 次のステップ
   - 担当部署への指示事項
   - 今後のスケジュール

**記述スタイル:**
- **1段落のみで構成**（改行なし）
- 簡潔で客観的な記述
- 1文は50-80文字程度
- 専門用語は必要最小限に
- 5つの要素を自然な文の流れで繋げる
- 接続詞を効果的に使い、論理的な展開を維持
- **アブストラクト段落の直後に、元のURLを改行して記載する**

**制約**:
- **アブストラクト全体で1,000字以内**（厳守）
- 提供された資料に実際にある内容のみ使用（推測・補足・創作禁止）
- メタデータ除外: ファイルサイズ、ソフトウェア要件、タイムスタンプ
- 宣言型で記述（「では」の重複を避ける）
- 議事録がない場合: 「議論の詳細は記録されていない」と明記

**アブストラクト例:**

## アブストラクト

```
第2回日本成長戦略会議は、日本経済の中長期的な成長を実現するための包括的な戦略を検討する場として設置され、前回会議では基本方針が確認されたが、今回は具体的な実行体制の構築が課題となっていた。本会議の目的は、17の戦略分野と8つの分野横断的課題について、官民が連携する検討体制を確立することである。会議では、成長戦略の検討体制と分野横断的課題への対応方向性が議題として取り上げられ、検討体制については各分野における官民の役割分担と連携の仕組みが提案され、分野横断的課題については労働市場改革、デジタル化、グリーン化などの重点領域が示された。具体的な決定事項として、本年度補正予算で6.4兆円の予算措置を講じることが確定し、このうち造船能力向上のための10年基金が創設され、複数年度にわたる継続的な支援体制が確保されることとなった。また、令和8年度税制改正大綱において、全業種を対象とした大胆な投資促進税制が導入され、建物を含む高付加価値設備投資に対して即時償却または税額控除7%を選択できる制度により、年間約4兆円の投資が見込まれている。今後の方針として、総理は担当大臣に対し官民投資ロードマップの策定を指示し、特に労働市場改革では心身の健康維持と従業者の選択を前提とした柔軟な働き方の実現を推進するとともに、家事支援サービスの公的資格化を加速し、女性の社会進出を支援する環境整備を進めることとした。
https://www.cas.go.jp/jp/seisaku/nipponseichosenryaku/kaigi/dai2/gijisidai.html
```

（上記例: 約590字、1段落 + URL）

**制約**:
- report.mdは将来のコンテキスト参照用として詳細に記述
- ただし全体で10,000字を超えないように調整
- アブストラクトは必ずコードフェンス（\`\`\`）で囲む（抽出可能にするため）
- 全てのPDFリンクは絶対URLで記載

## ステップ9: ファイル出力

### ディレクトリ構造
```
output/
└── {会議名}_{回数}_{日付}_report.md
```

例:
```
output/
└── 日本成長戦略会議_第2回_20251224_report.md
```

### 実装手順
1. `./output` ディレクトリを作成（存在しなければ）
2. Writeツールで1つのファイルを直接 `./output/` に作成
3. 完了メッセージを表示

**重要**: アブストラクトは必ずコードフェンス（\`\`\`）で囲んで記述し、プログラムで抽出可能にすること

# エラーハンドリング

1. **HTML取得失敗時**:
   - HTML再取得を試行
   - 正規化処理を実行
   - 再試行
   - 各段階でログ記録

2. **PDFダウンロード失敗時**:
   - curl のエラーメッセージを記録
   - そのPDFをスキップして次へ進む
   - 最低限の情報（ファイル名、URL）は detail.md に記載

3. **PDF読み取り失敗時**:
   - Read ツールのエラーを記録
   - そのPDFの内容は「読み取り不可」として記載

4. **日付・回数が取得できない場合**:
   - ユーザーに入力を求める

# 注意事項

- トークン消費を最小化するため、全文を読まず構造的アプローチを採用
- 推測や創作は絶対に行わず、実際にある情報のみを使用
- 議事録がない場合も明示的に記載
- 参考資料や名簿など本質的でない資料は読まない
